<?php
set_time_limit(0);
ini_set('memory_limit','2048M');

define('AREA', 'C');
$_SERVER['HTTP_HOST'] = 'extego.ru';
$_SERVER['HTTPS_HOST'] = 'extego.ru';

//define('NO_SESSION', true);
//define('DEVELOPMENT', true);
//
//ini_set('display_errors', 'on');
//error_reporting(E_ALL);

libxml_use_internal_errors(false);

require(dirname(__FILE__) . '/../init.php');

$arts = ['1207430003055','93416299','93416411','93413175','93410747','93416404','4650000910449','93415742','4612747596560','93416350','93416121','91275875','93722609','91275752','4078500051026','4610030815442','4078500010344','4003773085836','4242005108794','98297218','93416565','98291933','93411560','2000000009513','91272867','93727017','4607125632862','4660216090064','4630039339220','4650000914416','98294101','4627091940990','4610012351449','4610003060114','4680017456739','4680017450843','93411577','93415216','93413533','4607138519297','93410815','4650000914539','4630016806639','93414097','4680017450782','4607096689506','4897055286154','93411973','7330725066351','91271037','4895117889824','93416435','93411928','1207430001648','91275769','93414011','93411591','4897020606239','91271341','93720315','4630065972019','4895205118881','93411584','93416503','4610003062774','4620762935141','4680017450799','4897055285638','4630000768318','4630003365187','93416527','6952909008837','91270658','98291797','6920105032420','3253561830693','3830079120784','4897040855228','93412666','2000000264882','93410969','91275868','4003773087250','93416305','93412963','4607138514063','5054905283537','4620016725085','4690510012875','4690408123195','4630084110331','93725662','4627122729686','93416312','4601004065970','4627145959725','4607145152098','4607954301014','91276070','93413090','6935364071325','4039784447592','91275691','4610093520987','4627133229342','93416343','6935364088095','4811260008493','6952909064727','4610003061067','6952909062464','4630056670122','93412673','93412475','5055323609855','4811260002811','4620016722114','4897020607489','4210201405498','93415827','93411294','4610030815527','4610003062767','91279910','91275851','4631153129223','4630049919801','4610017471432','4650000914522','93723521','93722418','4054278796185','93416381','4895205102187','5035048031810','6952909008035','4897020617525','93416374','4897040856256','4895117889831','93411072','93411058','1207430000016','91278166','93416114','5054905245320','4606373316999','4630000766956','4897020620891','93411331','4895117880548','4630016037484','91275790','98291827','5055323640049','4680017453233','93413397','93412741','93412529','4007430240170','3165140943109','93722401','91275721','4680112760588','4607192091920','4610092014210','3838782393891','4260145689973','4607096689490','4630000765911','4007430338129','4607138513387','4680017454506','93410242','91663082','93720100','98291469','4044996202112','93416329','4610093513835','4660008013974','93413526','4897040856423','6942138950168','4690207010368','3165140452502','4607950330865','4630000767281','2000000264912','4680017455435','4610003064600','91275936','4897020604327','91272256','98296815','4044996233918','853190007676','4054278940106','4003773060116','3830079120753','93416442','6971674992615','4630058677457','4630058672926','4610030815459','4670033290332','93410709','4680017450126','4607138510881','4039784418349','91275783','6952909015552','4620747770378','4600545721239','93416459','4059952637143','6980018232782','93413083','4610003060107','4627122727019','4627162146955','93412871','4680017453301','4260298387122','4650000914577','6928431201831','4630058674173','6952909021546','4897020604013','4610017473573','4607145152845','4078500047227','4607954304961','4604334018203','4078500043489','6952909019925','4078500024228','4630016037101','98294248','6952909090740','4610093522257','4610092014548','4025410903877','4003773034087','4034229244699','4610093516713','4601004181465','93415223','1207430003888','93413144','4630000767298','4078500049078','4630030374626','4670033290325','4054278498041','93411102','4610003060046','93410266','93410228','4078500002257','91275943','4897020606277','4895205138520','4630169222720','93416510','93416428','4627167011029','4606373395741','4610093513576','1207430005776','4610003065904','4630025141684','7312972127375','93411126','93410112','93722166','98291834','4610093522387','4610093523940','4627133229373','4003773087281','4054278961330','4003773069935','5054905245337','4895205114500','4603726251693','6411501200761','4895205107014','6901660104197','3838782467219','4044996180359','88381643818','5035048072073','4892403101318','5055323623325','5055323605093','4610030815268','91279125','4607138514070','93410518','93410211','91279934','91275356','98291551','4897123477507','4811260007557','853190007942','4610092014074','5035048335154','4660216090057','93415889','2000321671277','4895205102958','4606373380907','6952909084794','4601004082854','4670033295412','4610017472606','8594181741958','6952909007649','1207430003857','6904504645757','4680017453783','93412604','4610093508015','9120099332187','2766905800012','4895117877036','4610003062941','91279187','4078500002080','91275929','4897020601555','853190007805','4003773087243','4013288173508','4003773021490','6971764325002','4630168360072','4610092014593','4610030815886','4650000914607','93412789','4680017456838','5010576835666','5010576853288','5010576853240','93412437','4630058672889','3838942748998','4607193751151','4981046050593','5035048095744','4034229210687','4606373323560','4895117880555','4680353000351','4610003064785','4610003062583','93410204','4039784205390','4606373261725','4897020617402','91275363','4897020611868','98296631','93728595','4811260012896','853190007836','6009710791103','4895205133310','7330129273669','4895205132146','93416596','3253561755521','5035048072172','4610092013732','4606373395727','6974129103376','4640028113205','4895227606304','4895227611650','4897040856454','4054278618265','6936358000253','3165140827645','4811260012407','4650000913723','6416931003548','4680020420277','4897020620884','4078500011662','4607145152081','7396323133666','4895117886588','4895117869789','4610003062194','4606373247019','6932502052703','4680017452977','93722890','4260221722556','4897020615521','4044996081809','946327912001','4897020606246','4044996036571','4650069794998','4003773087571','4610092014098','7330129301256','4003773085843','93417142','4975769471254','6941545601939','93416169','6920105026115','4627167010565','5035048544945','4606373404283','4601004026056','4610092014630','4610092012292','4601004164680','3253561801501','4627136502763','4620016723449','4620108021286','4894659002685','93413106','6936358000307','4627105058659','4059952570822','4894183308109','4630025141349','4005176874604','4607056502524','4007430287953','4260170940087','4680394012153','4054278638263','14601032932067','4650000918056','93411669','3253561956171','4034229211219','4607145152104','4892783101311','4607954301021','4897020620839','4604334015974','4895117881354','1950078172163','4610003060305','4610003060060','93722258','4260221723744','91275899','4897020604310','4044996056487','6952909025834','4897020610014','4606059016830','4620749260358','4610092016603','4895205138155','4650250415961','4650250412489','6009710791134','4013288173003','7330129308477','7330725007842','5035048099940','4003773084143','6971764328065','4607950334122','4895205117624','6920105090154','3253560361174','4670033293739','4607954308198','4670033297058','93415674','4895205118959','4660008013936','4660008017606','6908801075828','6980018236063','4690398074033','4606373404528','4610092011905','4620039365152','4895205102965','93413014','9912214900980','8594181740999','4650055271335','4620762935110','5055323640087','4061792182363','4007430338396','4005176863431','3440893268373','4670013360802','4607809990912','4630058677297','4630058670724','4607809999588','4895117864340','4680394012436','4606373315602','4061792152762','4034229024383','4034229172831','3165140955348','3165140860994','4260221723874','30012562670554','5055323628788','4610003060312','4610003064761','4610030813875','93410662','4607138518030','93410259','92175384','93724566','93722173','2155000918393','91276018','91275776','6952909015484','4606373210662','4606373217272','4620762933826','4606059017882','91271051','4260121754480','4260121751021','6952909091242','853190007331','850029165316','853190007751','4044996222493','850029165019','4630143130034','846647003574','7330129273652','6971764328621','4044996210339','4660114843564','4620762937701','93417104','93417128','4607193752547','4044996169361','93415650','4895205102156','4895205111479','4895205113619','4601004099739','4601004151727','403422912887601','3838782151668','4604898781209','4680017457798','4670033295023','4894187306200','4627133228512','4627162146870','4620016723425','4895117864128','4892416101213','4895227609251','6952909062174','4895227612008','4606800042125','4897040856355','4603010102342','6941264084204','4078500034272','93412864','4680017450812','4610093507988','4005176327858','4897020621232','760557820109','93412444','4897020620594','93412192','93412109','6935364088873','8690842291654','4630058677303','4630058674203','4690207135450','4719152300352','4612744726397','4650000918285','5056142116845','3838782120947','4044996180465','4895117885925','6952909052861','6416931006273','5035048083697','5035048077276','4007430305114','3253560121051','4606072009987','4895199615106','4607954305067','4242002717166','4078500048590','4897020620709','4897020620747','93411003','4610012355133','4680020420260','5055323623165','2155000968688','6952909005195','6932931678956','93722180','4260221724994','4078500870405','4078500820196','4897020617532','4630014580555','4034229038588','91275431','6952909017990','4044996023540','4044996002453','9120020760379','4260121752974','6956914627113','98291926','6900079077986','4650250416395','850029165071','853190007997','834456003137','834456003199','853190007829','853190007843','850029165354','4640165790475','5035048034590','4610092016337','4013288156143','4078500054249','2000000031477','6974100782842','93417296','4610092014180','2000998917111','4601004014404','4601004183278','4013288112255','4600545719021','93417135','8107003750382','4630017917198','4630017917259','4003773023197','4003773034032','5035048503652','2000000013893','4620016492703','6971764328713','6920105090222','6925105038038','4620016723432','4627167011821','4627167010534','4627167012194','4601004247277','4606800049094','4895205119659','4895205118751','4601004195707','4897040856324','4895205119642','4610092013046','4606373401152','5035048095553','7290100851036','4601004065963','4601004062207','4606373404054','6925281975042','4630043299381','8710103618713','93414707','4034229241643','4034229159726','4630016587545','4607146991443','4630055246670','4891005031214','817609011708','817609016192','4630011020160','4895227611810','4895227601293','4620108020784','4680017455428','4897040856553','4610093509401','4059952570785','4640000552305','4005176468834','4025416310679','4607100129455','760557828129','4698021216843','4620011770615','3210071000046','4895205123403','4714218150193','4630032461409','4690207000734','4607100120230','4690207256056','4607100129516','4630058670700','4610093501597','4630058677464','6952909053127','4897055285430','4610050701787','4607084195453','4650067304809','4606373309052','4610032712596','5035048095751','4007430337528','3253560962302','4078500042888','1207430003451','2155000476978','4650001856913','4630046770467','4670015923777','4606059025207','93411508','4604717023978','4811260002651','4897058502800','4895117871331','4895117880067','4895117880050','4630016032694','93411157','4260596983378','4606059027157','4811467000030','5055323616624','4650069791829','4034229060909','4610003062927','4610003064594','4975769458439','4650067305301','6932502053700','4607138519730','93725785','91279897','4078500870207','4039784346598','4034229143022','91274014','4897020607274','4897020617808','4260121750475'];

$products = db_get_hash_array('SELECT p.list_price, p.product_id, p.product_code, pd.product as name, pc.category_id, cd.category as category_name, pd.full_description, pd.short_description
                FROM ?:products p
                JOIN ?:product_descriptions pd ON (pd.product_id = p.product_id and pd.lang_code = "ru") 
                JOIN ?:products_categories pc ON (pc.product_id = p.product_id and pc.link_type = "M") 
                JOIN ?:category_descriptions cd ON (cd.category_id = pc.category_id and cd.lang_code = "ru") 
                WHERE p.product_code IN (?a)
                GROUP BY p.product_code
                ', 'product_id', $arts);

$productsPhotos = db_get_hash_multi_array('SELECT p.product_id, p.product_code, i.image_id, i.image_path
                FROM ?:products p
                JOIN ?:images_links il ON (il.object_id = p.product_id and il.object_type = "product" AND il.detailed_id != "") 
                JOIN ?:images i ON (i.image_id = il.detailed_id)
                WHERE p.product_code IN (?a)
                ORDER BY il.type DESC
                ', ['product_id', 'image_id', 'image_path'], $arts);

$allFeatures = db_get_hash_multi_array('SELECT *
                                    FROM ?:product_light_features
                                    WHERE product_id IN (?n)
                                    ', ['product_id', 'name', 'value'], array_keys($products));

$xml = new SimpleXMLElement('<?xml version="1.0" encoding="UTF-8"?><yml_catalog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" />');
$xml->addAttribute('date', date(DATE_ATOM));
$shopChild = $xml->addChild('shop');

$shopChild->addChild('name', 'Extego');
$shopChild->addChild('company', 'Extego');
$shopChild->addChild('url', 'https://extego.ru');
$cursChild = $shopChild->addChild('currencies');
$curChild = $cursChild->addChild('currency');
$curChild->addAttribute('id', 'RUR');
$curChild->addAttribute('rate', '1');

$categories = [];
foreach ($products as $productId => $product) {
    $categories[(int) $product['category_id']] = $product['category_name'];
}

ksort($categories);

$categoriesChild = $shopChild->addChild('categories');
foreach ($categories as $categoryId => $categoryName) {
    $categoryChild = $categoriesChild->addChild('category', $categoryName);
    $categoryChild->addAttribute('id', $categoryId);
}

$offersChild = $shopChild->addChild('offers');

foreach ($products as $productId => $product) {
    $offerChild = $offersChild->addChild('offer');
    $offerChild->addAttribute('id', $product['product_code']);
    $offerChild->addChild('url', fn_url(fn_exim_get_product_url($product['product_id'])));
    $offerChild->addChild('name', $product['name']);
    $offerChild->addChild('categoryId', $product['category_id']);
    $offerChild->addChild('currencyId', 'RUR');
    $offerChild->addChild('price', (float) $product['list_price']);
    $descriptionChild = $offerChild->addChild('description');
    $node = dom_import_simplexml($descriptionChild);
    $no = $node->ownerDocument;
    $node->appendChild($no->createCDATASection($product['full_description'] ?: $product['short_description'] ?: $product['name']));

    if (!empty($productsPhotos[$productId])) {
        foreach ($productsPhotos[$productId] as $imageId => $imagePath) {
            $offerChild->addChild('picture', 'https://extego.ru/images/detailed/' . floor($imageId / 1000) . '/' . $imagePath);
        }
    }

    $vendor = $allFeatures[$product['product_id']]['Brand'] ?? $allFeatures[$product['product_id']]['Бренд'] ?? '';
    if ($vendor) {
        $offerChild->addChild('vendor', $vendor);
    }
    $model = $allFeatures[$product['product_id']]['Модель'] ?? $allFeatures[$product['product_id']]['Model'] ?? '';
    if ($model) {
        $offerChild->addChild('model', $model);
    }
}

header('Content-Type: application/xml');

$dom = dom_import_simplexml($xml)->ownerDocument;
$dom->formatOutput = true;
echo $dom->saveXML();
